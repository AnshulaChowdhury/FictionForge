#!/bin/bash

# =============================================================================
# Consciousness Trilogy App - Startup Script
# =============================================================================
# Starts the full stack: Backend (Docker) + Frontend (local)
#
# Usage:
#   ./start        # Start everything
#   ./start --down # Stop everything
# =============================================================================

set -e  # Exit on error

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Helper functions
print_green() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

print_blue() {
    echo -e "${BLUE}â†’ $1${NC}"
}

print_yellow() {
    echo -e "${YELLOW}âš  $1${NC}"
}

print_red() {
    echo -e "${RED}âœ— $1${NC}"
}

print_header() {
    echo ""
    echo "============================================================"
    echo "$1"
    echo "============================================================"
    echo ""
}

# =============================================================================
# Check for --down flag
# =============================================================================

if [ "$1" == "--down" ]; then
    print_header "Stopping Docker Services"
    docker-compose down
    print_green "All services stopped"
    exit 0
fi

# =============================================================================
# Main Script
# =============================================================================

print_header "Consciousness Trilogy App"

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# =============================================================================
# Cleanup macOS Hidden Files
# =============================================================================

print_blue "Cleaning up macOS metadata files..."
# Count and delete ._* files silently
count=$(find . -name "._*" -type f 2>/dev/null | wc -l | tr -d ' ')
if [ "$count" -gt 0 ]; then
    find . -name "._*" -type f -delete 2>/dev/null
    print_green "Removed $count macOS metadata files"
else
    print_green "No cleanup needed"
fi

# =============================================================================
# Pre-flight Checks
# =============================================================================

print_blue "Checking prerequisites..."

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    print_red "Docker is not installed!"
    echo ""
    echo "Please install Docker Desktop:"
    echo "  https://www.docker.com/products/docker-desktop"
    echo ""
    exit 1
fi

print_green "Docker found"

# Check if Docker is running
if ! docker info &> /dev/null; then
    print_red "Docker is not running!"
    echo ""
    echo "Please start Docker Desktop and try again."
    echo ""
    exit 1
fi

print_green "Docker is running"

# Check if docker-compose is available
if ! command -v docker-compose &> /dev/null; then
    print_yellow "docker-compose not found, using 'docker compose' instead"
    DOCKER_COMPOSE="docker compose"
else
    DOCKER_COMPOSE="docker-compose"
fi

# Check if .env file exists
if [ ! -f "api/.env" ]; then
    print_red ".env file not found!"
    echo ""
    echo "Please create api/.env with your configuration"
    echo "See api/.env.example for required variables"
    echo ""
    exit 1
fi

print_green "Configuration file found"

# Check if node_modules exists for frontend
if [ ! -d "frontend/node_modules" ]; then
    print_yellow "Frontend dependencies not installed"
    read -p "Install frontend dependencies now? (y/n) " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        print_blue "Installing frontend dependencies..."
        cd frontend
        npm install
        cd ..
        print_green "Frontend dependencies installed"
    else
        print_red "Cannot start frontend without dependencies"
        exit 1
    fi
fi

# =============================================================================
# Start Docker Services
# =============================================================================

print_header "Starting Docker Services (Backend + Redis)"

print_blue "Building and starting containers..."
$DOCKER_COMPOSE up -d --build

# Wait for services to be healthy
print_blue "Waiting for services to be ready..."
sleep 3

# Check health
if docker ps | grep -q "consciousness-trilogy-api"; then
    print_green "Backend API running"
else
    print_red "Backend API failed to start"
    echo ""
    echo "Check logs with: docker-compose logs api"
    exit 1
fi

if docker ps | grep -q "consciousness-trilogy-redis"; then
    print_green "Redis running"
else
    print_red "Redis failed to start"
    exit 1
fi

# =============================================================================
# Start Frontend (Local)
# =============================================================================

print_header "Starting Frontend (Local)"

print_blue "Starting Vite dev server..."

# Store frontend PID for cleanup
FRONTEND_PID=""

# Cleanup function
cleanup() {
    echo ""
    print_yellow "Shutting down..."
    if [ ! -z "$FRONTEND_PID" ]; then
        kill $FRONTEND_PID 2>/dev/null || true
        print_green "Frontend stopped"
    fi
    print_blue "Docker services still running (use './start --down' to stop)"
    exit 0
}

trap cleanup SIGINT SIGTERM EXIT

cd frontend
npm run dev &
FRONTEND_PID=$!
cd ..

print_green "Frontend started (PID: $FRONTEND_PID)"

# =============================================================================
# Success!
# =============================================================================

sleep 2

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  ğŸš€ All services running!"
echo ""
echo "  Frontend:              http://localhost:5173"
echo "  Backend API:           http://localhost:8000"
echo "  API Documentation:     http://localhost:8000/docs"
echo ""
echo "  Useful commands:"
echo "    docker-compose logs -f api     # View backend logs"
echo "    ./start --down                 # Stop all services"
echo ""
echo "  Press Ctrl+C to stop frontend"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Wait for frontend
wait $FRONTEND_PID
