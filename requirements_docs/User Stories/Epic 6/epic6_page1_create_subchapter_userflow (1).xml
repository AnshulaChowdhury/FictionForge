<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2025-11-03T00:00:00.000Z" agent="draw.io" version="21.0.0">
  <diagram name="Page-1: Create Sub-Chapter Segments" id="epic6-page1">
    <mxGraphModel dx="2400" dy="1400" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="5500" pageHeight="2200" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        
        <!-- HEADER -->
        <mxCell id="header" value="EPIC 6 - SUB-CHAPTER MANAGEMENT SYSTEM&#xa;Page 1: Create Sub-Chapter Segments (with plot points &amp; writing prompts)" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="20" width="5400" height="60" as="geometry"/>
        </mxCell>
        
        <!-- SWIM LANES -->
        <!-- Lane 1: User -->
        <mxCell id="lane-user" value="User (Author)" style="swimlane;horizontal=0;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=14;fontStyle=1;startSize=120;" vertex="1" parent="1">
          <mxGeometry x="40" y="100" width="5400" height="200" as="geometry"/>
        </mxCell>
        
        <!-- Lane 2: Streamlit Frontend -->
        <mxCell id="lane-streamlit" value="Streamlit Frontend" style="swimlane;horizontal=0;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=14;fontStyle=1;startSize=120;" vertex="1" parent="1">
          <mxGeometry x="40" y="300" width="5400" height="280" as="geometry"/>
        </mxCell>
        
        <!-- Lane 3: FastAPI Backend -->
        <mxCell id="lane-fastapi" value="FastAPI Backend" style="swimlane;horizontal=0;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=14;fontStyle=1;startSize=120;" vertex="1" parent="1">
          <mxGeometry x="40" y="580" width="5400" height="360" as="geometry"/>
        </mxCell>
        
        <!-- Lane 4: Job Queue (pg-boss) -->
        <mxCell id="lane-jobqueue" value="Job Queue (pg-boss)" style="swimlane;horizontal=0;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=14;fontStyle=1;startSize=120;" vertex="1" parent="1">
          <mxGeometry x="40" y="940" width="5400" height="200" as="geometry"/>
        </mxCell>
        
        <!-- Lane 5: Supabase Database -->
        <mxCell id="lane-supabase" value="Supabase Database" style="swimlane;horizontal=0;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=14;fontStyle=1;startSize=120;" vertex="1" parent="1">
          <mxGeometry x="40" y="1140" width="5400" height="240" as="geometry"/>
        </mxCell>
        
        <!-- Lane 6: ChromaDB -->
        <mxCell id="lane-chromadb" value="ChromaDB Vector Store" style="swimlane;horizontal=0;whiteSpace=wrap;html=1;fillColor=#FFCCBC;strokeColor=#E64A19;fontSize=14;fontStyle=1;startSize=120;" vertex="1" parent="1">
          <mxGeometry x="40" y="1380" width="5400" height="240" as="geometry"/>
        </mxCell>
        
        <!-- =================================================================== -->
        <!-- USER ACTIONS -->
        <!-- =================================================================== -->
        
        <!-- Step 1: Navigate to Sub-Chapter Management -->
        <mxCell id="user-1" value="Navigate to&#xa;Sub-Chapter&#xa;Management Page" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=11;fontStyle=1;" vertex="1" parent="lane-user">
          <mxGeometry x="170" y="50" width="120" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 2: Select Chapter -->
        <mxCell id="user-2" value="Select Chapter&#xa;from Dropdown" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=11;fontStyle=1;" vertex="1" parent="lane-user">
          <mxGeometry x="570" y="50" width="120" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 3: Click "Create New Sub-Chapter" -->
        <mxCell id="user-3" value="Click&#xa;'Create New&#xa;Sub-Chapter'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=11;fontStyle=1;" vertex="1" parent="lane-user">
          <mxGeometry x="970" y="50" width="120" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 4: Fill Form -->
        <mxCell id="user-4" value="Fill Form:&#xa;• Title&#xa;• Plot Points&#xa;• Writing Prompt&#xa;• Target Word Count" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=10;align=left;" vertex="1" parent="lane-user">
          <mxGeometry x="1370" y="40" width="140" height="100" as="geometry"/>
        </mxCell>
        
        <!-- Step 5: Click Generate -->
        <mxCell id="user-5" value="Click&#xa;'Generate&#xa;Content'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=11;fontStyle=1;" vertex="1" parent="lane-user">
          <mxGeometry x="1770" y="50" width="120" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 6: View Progress -->
        <mxCell id="user-6" value="View Real-Time&#xa;Progress Updates&#xa;via WebSocket" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=11;fontStyle=1;" vertex="1" parent="lane-user">
          <mxGeometry x="3370" y="50" width="140" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 7: View Generated Content -->
        <mxCell id="user-7" value="View Generated&#xa;Content &amp;&#xa;Success Message" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=11;fontStyle=1;" vertex="1" parent="lane-user">
          <mxGeometry x="5070" y="50" width="140" height="80" as="geometry"/>
        </mxCell>
        
        <!-- =================================================================== -->
        <!-- STREAMLIT FRONTEND -->
        <!-- =================================================================== -->
        
        <!-- Step 1: Load Page -->
        <mxCell id="fe-1" value="Load Sub-Chapter&#xa;Management Page" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=11;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="170" y="40" width="120" height="70" as="geometry"/>
        </mxCell>
        
        <!-- Step 2: Fetch Chapters -->
        <mxCell id="fe-2" value="GET /api/chapters&#xa;?book_id={book_id}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=10;align=left;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="330" y="40" width="150" height="70" as="geometry"/>
        </mxCell>
        
        <!-- Step 3: Display Chapter Dropdown -->
        <mxCell id="fe-3" value="Display Chapter&#xa;Dropdown with&#xa;Chapter List" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=11;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="570" y="120" width="120" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 4: Display Create Button -->
        <mxCell id="fe-4" value="Display&#xa;'Create New&#xa;Sub-Chapter'&#xa;Button" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=11;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="770" y="40" width="120" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 5: Display Form -->
        <mxCell id="fe-5" value="Display Form:&#xa;• Sub-chapter Title*&#xa;• Plot Points*&#xa;• Writing Prompt*&#xa;• Target Word Count&#xa;  (default: 2000)&#xa;&#xa;Character auto-&#xa;inherited from chapter" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=10;align=left;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="970" y="120" width="150" height="140" as="geometry"/>
        </mxCell>
        
        <!-- Step 6: Validate Form -->
        <mxCell id="fe-6" value="Validate Form:&#xa;Required Fields?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=11;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="1370" y="140" width="140" height="100" as="geometry"/>
        </mxCell>
        
        <!-- Step 7: Show Validation Error -->
        <mxCell id="fe-7" value="Show Error:&#xa;'Title, Plot Points,&#xa;&amp; Writing Prompt&#xa;are required'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;fontSize=10;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="1560" y="150" width="130" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 8: Send API Request -->
        <mxCell id="fe-8" value="POST /api/sub-chapters&#xa;{&#xa;  chapter_id,&#xa;  title,&#xa;  plot_points,&#xa;  writing_prompt,&#xa;  target_word_count&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=9;align=left;fontFamily=Courier New;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="1770" y="130" width="150" height="100" as="geometry"/>
        </mxCell>
        
        <!-- Step 9: Show Loading -->
        <mxCell id="fe-9" value="Show Loading:&#xa;'Creating sub-chapter&#xa;&amp; queuing generation...'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=10;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="1970" y="40" width="150" height="70" as="geometry"/>
        </mxCell>
        
        <!-- Step 10: Receive Response -->
        <mxCell id="fe-10" value="Receive Response:&#xa;{&#xa;  sub_chapter_id,&#xa;  generation_job_id,&#xa;  status: 'processing',&#xa;  websocket_url&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=9;align=left;fontFamily=Courier New;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="2770" y="40" width="150" height="110" as="geometry"/>
        </mxCell>
        
        <!-- Step 11: Connect WebSocket -->
        <mxCell id="fe-11" value="Connect to&#xa;WebSocket:&#xa;/ws/generation-jobs/&#xa;{job_id}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=10;fontFamily=Courier New;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="2970" y="40" width="160" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 12: Display Progress -->
        <mxCell id="fe-12" value="Display Progress:&#xa;• Spinner animation&#xa;• Status messages&#xa;• Progress bar (if available)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=10;align=left;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="3370" y="130" width="160" height="90" as="geometry"/>
        </mxCell>
        
        <!-- Step 13: Receive Completion -->
        <mxCell id="fe-13" value="Receive WebSocket:&#xa;{&#xa;  status: 'completed',&#xa;  sub_chapter_id,&#xa;  word_count&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=9;align=left;fontFamily=Courier New;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="4770" y="40" width="150" height="90" as="geometry"/>
        </mxCell>
        
        <!-- Step 14: Fetch Generated Content -->
        <mxCell id="fe-14" value="GET /api/sub-chapters/&#xa;{sub_chapter_id}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#F57C00;fontSize=10;fontFamily=Courier New;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="4970" y="40" width="150" height="60" as="geometry"/>
        </mxCell>
        
        <!-- Step 15: Display Success -->
        <mxCell id="fe-15" value="Display:&#xa;• Success message&#xa;• Generated content&#xa;• Word count&#xa;• Navigation to edit" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;align=left;" vertex="1" parent="lane-streamlit">
          <mxGeometry x="5170" y="40" width="150" height="90" as="geometry"/>
        </mxCell>
        
        <!-- =================================================================== -->
        <!-- FASTAPI BACKEND -->
        <!-- =================================================================== -->
        
        <!-- Step 1: Receive Chapter Request -->
        <mxCell id="be-1" value="Receive GET&#xa;/api/chapters" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=11;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="330" y="140" width="150" height="60" as="geometry"/>
        </mxCell>
        
        <!-- Step 2: Query Chapters -->
        <mxCell id="be-2" value="Query Chapters&#xa;from Supabase:&#xa;SELECT * FROM chapters&#xa;WHERE book_id = ?" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;fontFamily=Courier New;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="330" y="220" width="170" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 3: Return Chapters -->
        <mxCell id="be-3" value="Return Chapter List&#xa;with character_id&#xa;for each chapter" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=11;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="540" y="140" width="130" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 4: Receive Sub-Chapter Request -->
        <mxCell id="be-4" value="Receive POST&#xa;/api/sub-chapters" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=11;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="1770" y="230" width="150" height="60" as="geometry"/>
        </mxCell>
        
        <!-- Step 5: Validate Request -->
        <mxCell id="be-5" value="Validate Request:&#xa;• chapter_id exists?&#xa;• title not empty?&#xa;• word_count valid?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="1970" y="210" width="160" height="100" as="geometry"/>
        </mxCell>
        
        <!-- Step 6: Return Validation Error -->
        <mxCell id="be-6" value="Return 400 Error:&#xa;{&#xa;  'error': 'validation_failed',&#xa;  'details': [...]&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;fontSize=9;fontFamily=Courier New;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="2180" y="220" width="150" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 7: Get Chapter Details -->
        <mxCell id="be-7" value="Query Chapter:&#xa;SELECT character_id&#xa;FROM chapters&#xa;WHERE id = ?" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;fontFamily=Courier New;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="2180" y="40" width="150" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 8: Get Next Sub-Chapter Number -->
        <mxCell id="be-8" value="Query Max Sub-Chapter #:&#xa;SELECT MAX(&#xa;  sub_chapter_number&#xa;) + 1&#xa;FROM sub_chapters&#xa;WHERE chapter_id = ?" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="2370" y="40" width="170" height="100" as="geometry"/>
        </mxCell>
        
        <!-- Step 9: Create Sub-Chapter Stub -->
        <mxCell id="be-9" value="Create Sub-Chapter&#xa;Stub in Supabase:&#xa;INSERT INTO sub_chapters&#xa;(id, chapter_id, character_id,&#xa;sub_chapter_number, title,&#xa;plot_points, status, ...)&#xa;VALUES (...)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="2570" y="40" width="180" height="120" as="geometry"/>
        </mxCell>
        
        <!-- Step 10: Create Generation Job Record -->
        <mxCell id="be-10" value="Create Generation Job:&#xa;INSERT INTO&#xa;generation_jobs&#xa;(id, sub_chapter_id,&#xa;status: 'pending', ...)&#xa;VALUES (...)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="2590" y="180" width="160" height="110" as="geometry"/>
        </mxCell>
        
        <!-- Step 11: Queue Job -->
        <mxCell id="be-11" value="Queue Job to pg-boss:&#xa;await job_queue.send(&#xa;  'generate_content',&#xa;  {&#xa;    job_id,&#xa;    sub_chapter_id,&#xa;    character_id,&#xa;    writing_prompt,&#xa;    plot_points,&#xa;    target_word_count&#xa;  }&#xa;)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=8;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="2790" y="40" width="160" height="160" as="geometry"/>
        </mxCell>
        
        <!-- Step 12: Return Response -->
        <mxCell id="be-12" value="Return 201 Response:&#xa;{&#xa;  sub_chapter_id,&#xa;  generation_job_id,&#xa;  status: 'processing',&#xa;  estimated_time: 180s,&#xa;  websocket_url&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="2790" y="220" width="160" height="120" as="geometry"/>
        </mxCell>
        
        <!-- Step 13: Process Generation Job (Worker) -->
        <mxCell id="be-13" value="WORKER PROCESS:&#xa;Receive Job from Queue" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=11;fontStyle=1;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="3170" y="40" width="160" height="60" as="geometry"/>
        </mxCell>
        
        <!-- Step 14: Update Job Status -->
        <mxCell id="be-14" value="Update Job:&#xa;SET status = 'processing',&#xa;started_at = NOW()&#xa;WHERE id = ?" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="3170" y="120" width="160" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 15: Send WebSocket Update -->
        <mxCell id="be-15" value="WebSocket Broadcast:&#xa;'Starting generation...'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="3370" y="40" width="160" height="60" as="geometry"/>
        </mxCell>
        
        <!-- Step 16: Retrieve Character Context -->
        <mxCell id="be-16" value="Retrieve Character&#xa;Context from ChromaDB:&#xa;similarity_search(&#xa;  writing_prompt,&#xa;  k=5&#xa;)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="3570" y="40" width="160" height="100" as="geometry"/>
        </mxCell>
        
        <!-- Step 17: WebSocket Update -->
        <mxCell id="be-17" value="WebSocket:&#xa;'Retrieving character&#xa;context...'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="3570" y="160" width="140" height="60" as="geometry"/>
        </mxCell>
        
        <!-- Step 18: Get Recent Chapters -->
        <mxCell id="be-18" value="Query Recent Chapters:&#xa;SELECT content&#xa;FROM sub_chapters&#xa;WHERE character_id = ?&#xa;ORDER BY created_at DESC&#xa;LIMIT 2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="3770" y="40" width="170" height="110" as="geometry"/>
        </mxCell>
        
        <!-- Step 19: Build Enhanced Prompt -->
        <mxCell id="be-19" value="Build Enhanced Prompt:&#xa;• Character profile&#xa;• Previous chapters (voice)&#xa;• Plot points&#xa;• Writing prompt&#xa;• Instructions" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="3970" y="40" width="160" height="100" as="geometry"/>
        </mxCell>
        
        <!-- Step 20: WebSocket Update -->
        <mxCell id="be-20" value="WebSocket:&#xa;'Generating content...'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="3970" y="160" width="140" height="60" as="geometry"/>
        </mxCell>
        
        <!-- Step 21: Generate Content -->
        <mxCell id="be-21" value="Generate Content:&#xa;await mistral_llm.generate(&#xa;  enhanced_prompt,&#xa;  max_tokens=...&#xa;)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="4170" y="40" width="170" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 22: Create Version -->
        <mxCell id="be-22" value="Create Version 1:&#xa;INSERT INTO&#xa;sub_chapter_versions&#xa;(sub_chapter_id,&#xa;version_number: 1,&#xa;content, word_count, ...)&#xa;VALUES (...)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="4370" y="40" width="170" height="120" as="geometry"/>
        </mxCell>
        
        <!-- Step 23: Update Sub-Chapter -->
        <mxCell id="be-23" value="Update Sub-Chapter:&#xa;UPDATE sub_chapters&#xa;SET&#xa;  content = ?,&#xa;  word_count = ?,&#xa;  status = 'completed'&#xa;WHERE id = ?" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="4370" y="180" width="170" height="120" as="geometry"/>
        </mxCell>
        
        <!-- Step 24: Add to Character ChromaDB -->
        <mxCell id="be-24" value="Add to Character&#xa;ChromaDB Collection:&#xa;collection.add(&#xa;  documents=[content],&#xa;  metadatas=[{&#xa;    sub_chapter_id&#xa;  }]&#xa;)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="4570" y="40" width="160" height="130" as="geometry"/>
        </mxCell>
        
        <!-- Step 25: Update Job Complete -->
        <mxCell id="be-25" value="Update Job:&#xa;SET status = 'completed',&#xa;completed_at = NOW()&#xa;WHERE id = ?" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="4570" y="190" width="160" height="80" as="geometry"/>
        </mxCell>
        
        <!-- Step 26: WebSocket Final -->
        <mxCell id="be-26" value="WebSocket:&#xa;{&#xa;  status: 'completed',&#xa;  sub_chapter_id,&#xa;  word_count&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="4770" y="190" width="140" height="90" as="geometry"/>
        </mxCell>
        
        <!-- Step 27: Return Sub-Chapter -->
        <mxCell id="be-27" value="GET Sub-Chapter:&#xa;SELECT sc.*, scv.content&#xa;FROM sub_chapters sc&#xa;JOIN sub_chapter_versions scv&#xa;WHERE sc.id = ?&#xa;AND scv.version_number = 1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="4970" y="180" width="170" height="120" as="geometry"/>
        </mxCell>
        
        <!-- Step 28: Return Content -->
        <mxCell id="be-28" value="Return 200:&#xa;{&#xa;  sub_chapter_id,&#xa;  title,&#xa;  content,&#xa;  word_count,&#xa;  version_number: 1,&#xa;  ...&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-fastapi">
          <mxGeometry x="5170" y="180" width="140" height="120" as="geometry"/>
        </mxCell>
        
        <!-- =================================================================== -->
        <!-- JOB QUEUE -->
        <!-- =================================================================== -->
        
        <!-- Job Queue Operations -->
        <mxCell id="jq-1" value="Receive Job:&#xa;'generate_content'&#xa;with payload" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=11;" vertex="1" parent="lane-jobqueue">
          <mxGeometry x="2790" y="50" width="150" height="80" as="geometry"/>
        </mxCell>
        
        <mxCell id="jq-2" value="Queue Job&#xa;for Worker&#xa;Processing" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=11;" vertex="1" parent="lane-jobqueue">
          <mxGeometry x="2990" y="50" width="120" height="80" as="geometry"/>
        </mxCell>
        
        <mxCell id="jq-3" value="Worker Picks Up Job&#xa;(async process)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=11;" vertex="1" parent="lane-jobqueue">
          <mxGeometry x="3170" y="50" width="140" height="80" as="geometry"/>
        </mxCell>
        
        <!-- =================================================================== -->
        <!-- SUPABASE DATABASE -->
        <!-- =================================================================== -->
        
        <!-- DB Operations -->
        <mxCell id="db-1" value="Query:&#xa;SELECT * FROM chapters&#xa;WHERE book_id = ?&#xa;ORDER BY chapter_number" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;align=left;" vertex="1" parent="lane-supabase">
          <mxGeometry x="330" y="50" width="190" height="80" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-2" value="Return:&#xa;Chapter list with&#xa;character_id for each" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;" vertex="1" parent="lane-supabase">
          <mxGeometry x="330" y="150" width="150" height="60" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-3" value="Query:&#xa;SELECT character_id&#xa;FROM chapters&#xa;WHERE id = ?" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;align=left;" vertex="1" parent="lane-supabase">
          <mxGeometry x="2180" y="50" width="150" height="70" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-4" value="Query:&#xa;SELECT MAX(sub_chapter_number) + 1&#xa;FROM sub_chapters&#xa;WHERE chapter_id = ?" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-supabase">
          <mxGeometry x="2370" y="50" width="200" height="70" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-5" value="INSERT:&#xa;sub_chapters&#xa;(status: 'draft')" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;" vertex="1" parent="lane-supabase">
          <mxGeometry x="2590" y="50" width="140" height="70" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-6" value="INSERT:&#xa;generation_jobs&#xa;(status: 'pending')" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;" vertex="1" parent="lane-supabase">
          <mxGeometry x="2590" y="140" width="140" height="70" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-7" value="UPDATE:&#xa;generation_jobs&#xa;SET status = 'processing'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;" vertex="1" parent="lane-supabase">
          <mxGeometry x="3170" y="50" width="160" height="70" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-8" value="Query:&#xa;SELECT content&#xa;FROM sub_chapters&#xa;WHERE character_id = ?&#xa;ORDER BY created_at DESC&#xa;LIMIT 2" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-supabase">
          <mxGeometry x="3770" y="50" width="180" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-9" value="INSERT:&#xa;sub_chapter_versions&#xa;(version_number: 1,&#xa;content, word_count)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;align=left;" vertex="1" parent="lane-supabase">
          <mxGeometry x="4370" y="50" width="160" height="80" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-10" value="UPDATE:&#xa;sub_chapters&#xa;SET content = ?,&#xa;word_count = ?,&#xa;status = 'completed'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;align=left;" vertex="1" parent="lane-supabase">
          <mxGeometry x="4370" y="150" width="160" height="80" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-11" value="UPDATE:&#xa;generation_jobs&#xa;SET status = 'completed',&#xa;completed_at = NOW()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=10;fontFamily=Courier New;align=left;" vertex="1" parent="lane-supabase">
          <mxGeometry x="4570" y="50" width="170" height="80" as="geometry"/>
        </mxCell>
        
        <mxCell id="db-12" value="Query:&#xa;SELECT sc.*, scv.content&#xa;FROM sub_chapters sc&#xa;JOIN sub_chapter_versions scv&#xa;ON sc.id = scv.sub_chapter_id&#xa;WHERE sc.id = ?&#xa;AND scv.version_number = 1" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-supabase">
          <mxGeometry x="4970" y="50" width="180" height="120" as="geometry"/>
        </mxCell>
        
        <!-- =================================================================== -->
        <!-- CHROMADB VECTOR STORE -->
        <!-- =================================================================== -->
        
        <!-- ChromaDB Operations -->
        <mxCell id="chroma-1" value="Similarity Search:&#xa;collection_name:&#xa;  {trilogy_id}_character_&#xa;  {character_id}&#xa;&#xa;query: writing_prompt&#xa;k: 5&#xa;&#xa;Returns: Top 5 relevant&#xa;character context chunks" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCCBC;strokeColor=#E64A19;fontSize=10;fontFamily=Courier New;align=left;" vertex="1" parent="lane-chromadb">
          <mxGeometry x="3570" y="40" width="180" height="150" as="geometry"/>
        </mxCell>
        
        <mxCell id="chroma-2" value="Add Document:&#xa;collection.add(&#xa;  documents=[&#xa;    generated_content&#xa;  ],&#xa;  metadatas=[{&#xa;    'sub_chapter_id': id,&#xa;    'created_at': timestamp&#xa;  }]&#xa;)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCCBC;strokeColor=#E64A19;fontSize=9;fontFamily=Courier New;align=left;" vertex="1" parent="lane-chromadb">
          <mxGeometry x="4570" y="40" width="170" height="140" as="geometry"/>
        </mxCell>
        
        <!-- =================================================================== -->
        <!-- EDGES / CONNECTIONS -->
        <!-- =================================================================== -->
        
        <!-- User to Frontend -->
        <mxCell id="edge1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="user-1" target="fe-1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Frontend: Load to API Call -->
        <mxCell id="edge2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-1" target="fe-2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Frontend to Backend: Get Chapters -->
        <mxCell id="edge3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-2" target="be-1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Backend to Database: Query Chapters -->
        <mxCell id="edge4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-2" target="db-1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-1" target="be-2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Database Return -->
        <mxCell id="edge6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-1" target="db-2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Backend Return -->
        <mxCell id="edge7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-2" target="be-3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Frontend Display -->
        <mxCell id="edge8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-3" target="fe-3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-3" target="fe-4">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- User Select Chapter -->
        <mxCell id="edge10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-3" target="user-2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- User Click Create -->
        <mxCell id="edge11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="user-2" target="user-3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge12" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="user-3" target="fe-5">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- User Fill Form -->
        <mxCell id="edge13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-5" target="user-4">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- User Submit -->
        <mxCell id="edge14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="user-4" target="user-5">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Frontend Validate -->
        <mxCell id="edge15" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="user-5" target="fe-6">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Validation Error Path -->
        <mxCell id="edge16" value="Invalid" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#C62828;fontSize=11;fontColor=#C62828;" edge="1" parent="1" source="fe-6" target="fe-7">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Validation Success Path -->
        <mxCell id="edge17" value="Valid" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#388E3C;fontSize=11;fontColor=#388E3C;" edge="1" parent="1" source="fe-6" target="fe-8">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Error back to form -->
        <mxCell id="edge18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#C62828;dashed=1;" edge="1" parent="1" source="fe-7" target="fe-5">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- API Request -->
        <mxCell id="edge19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-8" target="fe-9">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge20" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-8" target="be-4">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Backend Validation -->
        <mxCell id="edge21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-4" target="be-5">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Backend Validation Error -->
        <mxCell id="edge22" value="Invalid" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#C62828;fontSize=11;fontColor=#C62828;" edge="1" parent="1" source="be-5" target="be-6">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Backend Validation Success -->
        <mxCell id="edge23" value="Valid" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#388E3C;fontSize=11;fontColor=#388E3C;" edge="1" parent="1" source="be-5" target="be-7">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Get Chapter Character -->
        <mxCell id="edge24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-7" target="db-3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Get Next Number -->
        <mxCell id="edge25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-3" target="be-8">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-8" target="db-4">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Create Stub -->
        <mxCell id="edge27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-4" target="be-9">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-9" target="db-5">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Create Job -->
        <mxCell id="edge29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-5" target="be-10">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-10" target="db-6">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Queue Job -->
        <mxCell id="edge31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-6" target="be-11">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-11" target="jq-1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Return Response -->
        <mxCell id="edge33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-11" target="be-12">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-12" target="fe-10">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- WebSocket Connect -->
        <mxCell id="edge35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-10" target="fe-11">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Job Queue -->
        <mxCell id="edge36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="jq-1" target="jq-2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge37" value="Async" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;fontSize=10;" edge="1" parent="1" source="jq-2" target="jq-3">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Worker Process -->
        <mxCell id="edge38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="jq-3" target="be-13">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Update Job Status -->
        <mxCell id="edge39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-13" target="be-14">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-14" target="db-7">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- WebSocket Updates -->
        <mxCell id="edge41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="be-14" target="be-15">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#1976D2;" edge="1" parent="1" source="be-15" target="fe-12">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#1976D2;" edge="1" parent="1" source="fe-12" target="user-6">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Retrieve Character Context -->
        <mxCell id="edge44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-7" target="be-16">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-16" target="chroma-1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="be-16" target="be-17">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge47" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#1976D2;" edge="1" parent="1" source="be-17" target="fe-12">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Get Recent Chapters -->
        <mxCell id="edge48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="chroma-1" target="be-18">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge49" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-18" target="db-8">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Build Prompt -->
        <mxCell id="edge50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-8" target="be-19">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge51" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="be-19" target="be-20">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#1976D2;" edge="1" parent="1" source="be-20" target="fe-12">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Generate Content -->
        <mxCell id="edge53" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-19" target="be-21">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Create Version -->
        <mxCell id="edge54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-21" target="be-22">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge55" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-22" target="db-9">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Update Sub-Chapter -->
        <mxCell id="edge56" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-9" target="be-23">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge57" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-23" target="db-10">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Add to ChromaDB -->
        <mxCell id="edge58" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-10" target="be-24">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-24" target="chroma-2">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Update Job Complete -->
        <mxCell id="edge60" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="chroma-2" target="be-25">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge61" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-25" target="db-11">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Final WebSocket -->
        <mxCell id="edge62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="db-11" target="be-26">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge63" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;strokeColor=#1976D2;" edge="1" parent="1" source="be-26" target="fe-13">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- Fetch Content -->
        <mxCell id="edge64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-13" target="fe-14">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge65" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="fe-14" target="be-27">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge66" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-27" target="db-12">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge67" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="db-12" target="be-28">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="be-28" target="fe-15">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <mxCell id="edge69" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#388E3C;" edge="1" parent="1" source="fe-15" target="user-7">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        
        <!-- =================================================================== -->
        <!-- FOOTER / LEGEND -->
        <!-- =================================================================== -->
        
        <mxCell id="footer-legend" value="LEGEND:&#xa;• Solid Lines = Synchronous flow&#xa;• Dashed Lines = WebSocket real-time updates&#xa;• Green = Success path&#xa;• Red = Error path&#xa;• Blue = User interaction" style="text;html=1;strokeColor=#666666;fillColor=#F5F5F5;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=11;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="40" y="1640" width="400" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="footer-notes" value="KEY TECHNICAL DETAILS:&#xa;• Sub-chapter stub created BEFORE generation (immediate response)&#xa;• Character ID auto-inherited from chapter via trigger&#xa;• Generation runs asynchronously via pg-boss job queue&#xa;• Real-time progress via WebSocket connection&#xa;• Character context retrieved from ChromaDB (top 5 relevant chunks)&#xa;• Recent chapters queried for voice consistency&#xa;• Content saved as Version 1 in sub_chapter_versions table&#xa;• Generated content added to character's ChromaDB collection for future RAG&#xa;• Target generation time: 2-3 minutes for 2000-word content" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="480" y="1640" width="900" height="160" as="geometry"/>
        </mxCell>
        
        <mxCell id="footer-tables" value="DATABASE TABLES INVOLVED:&#xa;• chapters (character_id lookup)&#xa;• sub_chapters (stub creation, status updates)&#xa;• sub_chapter_versions (Version 1 storage)&#xa;• generation_jobs (async job tracking)&#xa;• ChromaDB: {trilogy_id}_character_{character_id} collection" style="text;html=1;strokeColor=#7B1FA2;fillColor=#E1BEE7;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="1420" y="1640" width="600" height="120" as="geometry"/>
        </mxCell>
        
        <mxCell id="footer-api" value="API ENDPOINTS:&#xa;• GET /api/chapters?book_id={id}&#xa;• POST /api/sub-chapters (creates stub + queues job)&#xa;• GET /api/sub-chapters/{id} (fetch generated content)&#xa;• WebSocket: /ws/generation-jobs/{job_id} (real-time updates)" style="text;html=1;strokeColor=#388E3C;fillColor=#C8E6C9;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="2060" y="1640" width="520" height="100" as="geometry"/>
        </mxCell>
        
        <mxCell id="footer-error" value="ERROR HANDLING:&#xa;• Frontend validation (required fields)&#xa;• Backend validation (400 errors)&#xa;• Database constraint violations&#xa;• ChromaDB connection failures (graceful degradation)&#xa;• LLM generation failures (job status: 'failed')&#xa;• WebSocket disconnections (reconnect logic)" style="text;html=1;strokeColor=#C62828;fillColor=#FFCDD2;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="2620" y="1640" width="520" height="120" as="geometry"/>
        </mxCell>
        
        <mxCell id="footer-timing" value="PERFORMANCE TARGETS:&#xa;• Stub creation: &lt; 500ms&#xa;• Queue job: &lt; 100ms&#xa;• API response time: &lt; 1s&#xa;• Character context retrieval: &lt; 2s&#xa;• Content generation: 2-3 minutes&#xa;• Total user wait: 2-3 minutes with real-time feedback" style="text;html=1;strokeColor=#F9A825;fillColor=#FFF9C4;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="3180" y="1640" width="520" height="120" as="geometry"/>
        </mxCell>
        
        <mxCell id="footer-epic" value="EPIC 6 - SUB-CHAPTER MANAGEMENT SYSTEM | Page 1 of 5 | User Story: Create Sub-Chapter Segments with Plot Points &amp; Writing Prompts" style="text;html=1;strokeColor=#1976D2;fillColor=#BBDEFB;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=11;fontStyle=1;fontFamily=Arial;" vertex="1" parent="1">
          <mxGeometry x="3740" y="1640" width="1700" height="40" as="geometry"/>
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
