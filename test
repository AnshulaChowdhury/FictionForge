#!/bin/bash

# =============================================================================
# Consciousness Trilogy App - Test Runner Script
# =============================================================================
# This script runs the test suite for the backend
# =============================================================================

set -e  # Exit on error

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Helper functions
print_green() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_blue() {
    echo -e "${BLUE}→ $1${NC}"
}

print_yellow() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_red() {
    echo -e "${RED}✗ $1${NC}"
}

print_header() {
    echo ""
    echo "============================================================"
    echo "$1"
    echo "============================================================"
    echo ""
}

# =============================================================================
# Main Script
# =============================================================================

print_header "Consciousness Trilogy App - Running Tests"

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Check if virtual environment exists
if [ ! -d "venv" ]; then
    print_red "Virtual environment not found!"
    echo ""
    echo "Please run the setup first:"
    echo "  python3 -m venv venv"
    echo "  source venv/bin/activate"
    echo "  pip install -r api/requirements.txt"
    echo ""
    exit 1
fi

print_green "Virtual environment found"

# Activate virtual environment
print_blue "Activating virtual environment..."
source venv/bin/activate

# Change to API directory
cd api

# Parse command line arguments
TEST_TYPE="${1:-all}"

case $TEST_TYPE in
    "unit")
        print_header "Running Unit Tests"
        ../venv/bin/pytest tests/unit -v --no-cov
        ;;
    "integration")
        print_header "Running Integration Tests"
        ../venv/bin/pytest tests/integration -v --no-cov
        ;;
    "coverage")
        print_header "Running Tests with Coverage"
        ../venv/bin/pytest tests -v --cov=api --cov-report=html --cov-report=term-missing
        echo ""
        print_green "Coverage report generated: api/htmlcov/index.html"
        ;;
    "all")
        print_header "Running All Tests"
        ../venv/bin/pytest tests -v --no-cov
        ;;
    "e2e")
        # Go back to root and into frontend
        cd "$SCRIPT_DIR/frontend"

        # Check if node_modules exists
        if [ ! -d "node_modules" ]; then
            print_red "Frontend dependencies not installed!"
            echo ""
            echo "Please run: cd frontend && npm install"
            echo ""
            exit 1
        fi

        # Check if Playwright is installed
        if [ ! -d "node_modules/@playwright" ]; then
            print_red "Playwright not installed!"
            echo ""
            echo "Please run: cd frontend && npx playwright install"
            echo ""
            exit 1
        fi

        # Parse e2e flags for individual test files
        E2E_TEST_FILE=""
        shift  # Remove 'e2e' from args

        while [[ $# -gt 0 ]]; do
            case $1 in
                --auth)
                    E2E_TEST_FILE="auth.spec.ts"
                    ;;
                --trilogy)
                    E2E_TEST_FILE="trilogy-management.spec.ts"
                    ;;
                --character)
                    E2E_TEST_FILE="character-management.spec.ts"
                    ;;
                --world-rules)
                    E2E_TEST_FILE="world-rules.spec.ts"
                    ;;
                --chapter)
                    E2E_TEST_FILE="chapter-management.spec.ts"
                    ;;
                --sub-chapter)
                    E2E_TEST_FILE="sub-chapter-management.spec.ts"
                    ;;
                --integration)
                    E2E_TEST_FILE="integration-workflows.spec.ts"
                    ;;
                --ui)
                    print_header "Running E2E Tests with Playwright UI"
                    npx playwright test --ui
                    exit $?
                    ;;
                --help)
                    echo ""
                    echo "E2E Test Options:"
                    echo "  ./test e2e              # Run all e2e tests"
                    echo "  ./test e2e --auth       # Run auth tests"
                    echo "  ./test e2e --trilogy    # Run trilogy management tests"
                    echo "  ./test e2e --character  # Run character management tests"
                    echo "  ./test e2e --world-rules # Run world rules tests"
                    echo "  ./test e2e --chapter    # Run chapter management tests"
                    echo "  ./test e2e --sub-chapter # Run sub-chapter management tests"
                    echo "  ./test e2e --integration # Run integration workflow tests"
                    echo "  ./test e2e --ui         # Run with Playwright UI"
                    echo ""
                    exit 0
                    ;;
                *)
                    print_red "Unknown e2e option: $1"
                    echo "Use './test e2e --help' for available options"
                    exit 1
                    ;;
            esac
            shift
        done

        if [ -n "$E2E_TEST_FILE" ]; then
            print_header "Running E2E Tests: $E2E_TEST_FILE"
            npx playwright test "tests/e2e/$E2E_TEST_FILE"
        else
            print_header "Running All E2E Tests"
            npx playwright test
        fi
        ;;
    *)
        print_red "Unknown test type: $TEST_TYPE"
        echo ""
        echo "Usage: ./test [unit|integration|coverage|all|e2e]"
        echo ""
        echo "Examples:"
        echo "  ./test           # Run all backend tests (default)"
        echo "  ./test unit      # Run only unit tests"
        echo "  ./test integration   # Run only integration tests"
        echo "  ./test coverage  # Run with coverage report"
        echo "  ./test e2e       # Run all frontend e2e tests"
        echo "  ./test e2e --auth    # Run specific e2e test"
        echo "  ./test e2e --help    # Show all e2e options"
        echo ""
        exit 1
        ;;
esac

# Check exit code
if [ $? -eq 0 ]; then
    echo ""
    print_green "All tests passed!"
    echo ""
else
    echo ""
    print_red "Tests failed!"
    echo ""
    exit 1
fi
